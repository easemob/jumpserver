{% extends 'base.html' %}
{% load static %}
{% load bootstrap3 %}
{% load i18n %}
{% load common_tags %}

{% block content %}
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="tab-content">
                        <div class="ibox-content" style="border-width: 0;padding-top: 40px;">
                            <table class="table table-striped table-bordered table-hover "
                                   id="file_task_list_table"
                                   style="width: 100%">
                                <thead>
                                <tr>
                                    <th class="text-center">{% trans 'Name' %}</th>
                                    <th class="text-center">{% trans 'Description' %}</th>
                                    <th class="text-center">{% trans 'Task' %}</th>
                                    <th class="text-center">{% trans 'Crontab' %}</th>
                                    <th class="text-center">{% trans 'User' %}</th>
                                    <th class="text-center">{% trans 'Date' %}</th>
                                    <th class="text-center">{% trans 'Action' %}</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    {% include 'ops/_json_content_modal.html' %}
{% endblock %}

{% block custom_foot_js %}
    <script>
      var asset_table = 0
      var table_data = {}

      function showInfo(asset_id) {
        var $body_modal = $('#content_modal')
        $('#content-body').empty().text(JSON.stringify(table_data[asset_id], null, 4))
        $body_modal.modal({show: true})
      }


      function disableCrontabTask(asset_id) {
        $.ajax({
          url: '{% url "api-ops:crontab-task-detail" pk=DEFAULT_PK %}'.replace("{{ DEFAULT_PK }}", asset_id),
          type: 'PATCH',
          data: JSON.stringify({enabled: false}),
          contentType: "application/json",
          success: function () {
            asset_table.ajax.reload()
            toastr.success('已成功禁用!')
          },
          error: function (data) {
            toastr.error(data)
          }
        })
      }

      function enableCrontabTask(asset_id) {
        $.ajax({
          url: '{% url "api-ops:crontab-task-detail" pk=DEFAULT_PK %}'.replace("{{ DEFAULT_PK }}", asset_id),
          type: 'PATCH',
          data: JSON.stringify({enabled: true}),
          contentType: "application/json",
          success: function () {
            asset_table.ajax.reload()
            toastr.success('已成功开启!')
          },
          error: function (data) {
            toastr.error(data)
          }
        })

      }

      function deleteCrontabTask(asset_id, name) {

        swal({
          title: "{% trans 'Are you sure?' %}",
          text: `确认删除(${name})这个定时任务!!!`,
          type: "warning",
          showCancelButton: true,
          cancelButtonText: "{% trans 'Cancel' %}",
          confirmButtonColor: "#DD6B55",
          confirmButtonText: "{% trans 'Confirm' %}",
          closeOnConfirm: false
        }, function () {
          function success() {
            var msg = "{% trans 'Asset Deleted.' %}";
            asset_table.ajax.reload()
            swal("{% trans 'Asset Delete' %}", msg, "success");
          }

          function fail() {
            var msg = "{% trans 'Asset Deleting failed.' %}";
            swal("{% trans 'Asset Delete' %}", msg, "error");
          }

          APIUpdateAttr({
            url: "{% url 'api-ops:crontab-task-detail' pk=DEFAULT_PK %}".replace('{{ DEFAULT_PK }}', asset_id),
            method: 'DELETE',
            success: success,
            error: fail
          })
        })
      }


      function initTable() {
        var options = {
          ele: $('#file_task_list_table'),
          columnDefs: [
            {
              targets: 0, createdCell: function (td, cellData, rowData) {
                cellData = htmlEscape(cellData);
                table_data[rowData.id] = rowData
                $(td).html(cellData);
              }
            },
            {
              targets: 2, createdCell: function (td, cellData, rowData) {
                var the_url = "{% url 'ops:task-detail-info' pk=DEFAULT_PK %}".replace("{{ DEFAULT_PK }}", cellData);
                var html = '<a href="' + the_url + '">查看任务</a>'
                $(td).html(html);
              }
            },
            {
              targets: 5, createdCell: function (td, cellData) {
                var html = ''
                html += new Date(htmlEscape(cellData)).toLocaleDateString();
                $(td).html(html);
              },
            },
            {
              targets: 6, createdCell: function (td, cellData, rowData) {
                html = '<button class="btn btn-success btn-xs" style="margin-right:5px" onclick="showInfo(\'' + cellData + '\')">详情</button>'
                table_data[rowData.id] = rowData
                if (rowData.enabled) {
                  html += '<button class="btn btn-xs btn-warning" onclick="disableCrontabTask(\'' + cellData + '\')">禁用</button>'
                } else {
                  html += '<button class="btn btn-xs btn-primary" onclick="enableCrontabTask(\'' + cellData + '\')">启用</button>'
                }
                html += '<button class="btn btn-xs btn-danger" style="margin-left:5px" onclick="deleteCrontabTask(\'' + cellData + '\', \'' + rowData.name + '\')">删除</button>'
                $(td).html(html);
              },
            },
          ],
          ajax_url: '{% url "api-ops:crontab-task-list" %}',
          columns: [
            {data: "name", orderable: false},
            {data: "description", orderable: false},
            {data: "task_meta", orderable: false},
            {data: "crontab", orderable: false},
            {data: "created_by", orderable: false},
            {data: "date_created", orderable: true},
            {data: "id", orderable: false},
          ],
          op_html: $('#actions').html()
        };
        asset_table = jumpserver.initServerSideDataTable(options);
        return asset_table
      }

      $(document).ready(function () {
        initTable()
      })

    </script>
{% endblock %}
