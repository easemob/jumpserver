{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load bootstrap3 %}

{% block custom_head_css_js %}
    <link rel="stylesheet" href="{% static 'js/plugins/xterm/xterm.css' %}"/>
    <link href="{% static 'css/plugins/select2/select2.min.css' %}" rel="stylesheet">
    <script src="{% static 'js/jquery.form.min.js' %}"></script>
    <script src="{% static 'js/plugins/select2/select2.full.min.js' %}"></script>
    <style type="text/css">
        .xterm .xterm-screen canvas {
            position: absolute;
            left: 0;
            top: 0;
            padding: 10px;
        }

        .select2-container .select2-selection--single {
            height: 34px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="wrapper wrapper-content">
        <div class="col-lg-12 animated fadeInRight" id="split-right">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>
                        {% block box-title %}
                            创建工作流
                        {% endblock %}
                    </h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                            <i class="fa fa-wrench"></i>
                        </a>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">

                    <form id="job-form" method="post" action="" class="form-horizontal">
                        {% csrf_token %}
                        <div class="form-group required">
                            <label for="jobname" class="col-sm-2 control-label">作业名称</label>
                            <div class="col-sm-9">
                                <input required="true" type="text" class="form-control" name="name" id="jobname"
                                       placeholder="作业名称">
                            </div>
                        </div>
                        <div id="task-list">
                            <div class="form-group required">
                                <label class="col-sm-2 control-label">任务选择</label>
                                <div class="col-sm-9 ">
                                    <select required name="tasks" class="select2 form-control task-choice"
                                            multiple="multiple">
                                        {% for task in task_meta %}
                                            <option value="{{ task.id }}">{{ task.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-1" style="padding: 6px 0">
                                    <a class="btn btn-danger btn-xs btn-task btn-del disabled">
                                        <span class="fa fa-minus"></span>
                                    </a>
                                    <a class="btn btn-primary btn-xs btn-task btn-add">
                                        <span class="fa fa-plus"></span>
                                    </a>
                                </div>
                            </div>
                        </div>


                        <div class="form-group required">
                            <label for="job-description" class="col-sm-2 control-label">作业描述</label>
                            <div class="col-sm-9">
                                <textarea required name="description" cols="40" rows="5" maxlength="128"
                                          class="form-control"
                                          title="" id="job-description"></textarea>
                                </textarea>
                            </div>
                        </div>


                        <div class="row">
                            <div class="col-sm-9 col-sm-offset-2">
                                <button style="width:100%" class="btn btn-primary" type="submit">
                                    {% block submit-button-content %}
                                        创 建
                                    {% endblock %}

                                </button>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block custom_foot_js %}
    <script>
      var systemUserId = null;


      function taskBtnShow() {
        $("#task-list .btn-task.btn-add").hide();
        $("#task-list .btn-task.btn-add:last").show();
      }


      function handleFormData(data) {
        const job_tasks = []
        $.each($('#task-list .task-choice'), function () {
          job_tasks.push($(this).val())
        })
        data.tasks = job_tasks
        console.log(data)
        return data
      }

      {% block extra_js_function %}

      {% endblock %}
      const taskDom = `<div class="form-group required task-template">
                            <label class="col-sm-2 control-label">下一步任务选择</label>
                            <div class="col-sm-9 ">
                                <select name="tasks" class="select2 form-control task-choice" multiple="multiple">
                                    {% for task in task_meta %}
                                        <option value="{{ task.id }}">{{ task.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-1" style="padding: 6px 0">
                                <a class="btn btn-danger btn-xs btn-task btn-del">
                                    <span class="fa fa-minus"></span>
                                </a>
                                <a class="btn btn-primary btn-xs btn-task btn-add">
                                    <span class="fa fa-plus"></span>
                                </a>
                            </div>
                        </div>`
      $(document).ready(function () {
        $('#task-list .select2:last').select2({
          placeholder: '请选择初始任务',
          closeOnSelect: false,
          allowClear: true
        });
        taskBtnShow()

      }).on("click", ".btn-task.btn-del", function () {
        $(this).parent().parent().remove();
        taskBtnShow()
      }).on("click", ".btn-task.btn-add", function () {
        const $taskDom = $(taskDom)
        $("#task-list").append($taskDom);
        $taskDom.find('.select2').select2({
          placeholder: '请选择下一步的任务',
          closeOnSelect: false,
          allowClear: true
        })
        taskBtnShow()

      }).on('submit', '#job-form', function (evt) {
        evt.preventDefault();
        var data = $(this).serializeObject()
        handleFormData(data)
        {% block submit_form_info %}
          var url = '{% url "api-ops:job-create" %}'
          var method = 'POST'
          var success_message = '创建成功'
        {%endblock %}
        var props = {
          url: url,
          data: handleFormData(data),
          method: method,
          form: $('#job-form'),
          error: function (jqXHR) {
            toastr.error(jqXHR.responseText)
          },
          success: function () {
            toastr.success(success_message)
          }
        }
        formSubmit(props);
      })
    </script>
{% endblock %}